# 워크플로우 이름
name: Deploy Flobank API and AP Servers

# 실행 시점: main 브랜치에 push가 발생할 때 실행
on:
  push:
    branches: [ main ] # (만약 브랜치 이름이 master라면 [ master ] 로 수정하세요)

# 실행될 작업들
jobs:
  # 1. 빌드 작업: 두 프로젝트를 모두 빌드
  build:
    runs-on: ubuntu-latest # 빌드 환경 (GitHub 제공)
    steps:
    - name: 1. 코드 체크아웃
      uses: actions/checkout@v4

    - name: 2. JDK 21 설치
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: 3. flobank-api 빌드 (Gradle)
      run: |
        cd flobank-api
        chmod +x ./gradlew
        ./gradlew build

    - name: 4. flobank-ap 빌드 (Gradle)
      run: |
        cd flobank-ap
        chmod +x ./gradlew
        ./gradlew build
        
    - name: 5. API 서버 아티팩트(빌드 파일) 업로드
      uses: actions/upload-artifact@v4
      with:
        name: api-jar # 아티팩트 이름 (임시 저장)
        path: flobank-api/build/libs/*.jar # 빌드된 .jar 파일 경로

    - name: 6. AP 서버 아티팩트(빌드 파일) 업로드
      uses: actions/upload-artifact@v4
      with:
        name: ap-jar # 아티팩트 이름 (임시 저장)
        path: flobank-ap/build/libs/*.jar # 빌드된 .jar 파일 경로

  # 2. API 서버 배포 작업
  deploy-api:
    needs: build # build 작업이 성공해야 실행
    runs-on: ubuntu-latest
    steps:
    - name: 1. API 서버 아티팩트 다운로드
      uses: actions/download-artifact@v4
      with:
        name: api-jar # build에서 업로드한 이름

    - name: 2. API 서버에 배포 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.API_SERVER_HOST }}     # GitHub Secret에서 가져오기
        username: ${{ secrets.API_SERVER_USER }} # GitHub Secret에서 가져오기
        key: ${{ secrets.API_SERVER_KEY }}      # GitHub Secret에서 가져오기
        script: |
          # 1. 기존에 실행 중인 API 서버 종료 (오류가 나도 계속 진행)
          pkill -f 'flobank-api.jar' || true
          
          # 2. 새 .jar 파일을 서버의 /home/ubuntu/api/ 폴더로 이동 (경로는 예시)
          #    (이 폴더는 서버에 미리 만들어 두어야 합니다!)
          mkdir -p /home/ubuntu/api
          mv ./*.jar /home/ubuntu/api/flobank-api.jar
          
          # 3. 'prod' 프로필로 새 애플리케이션 실행
          cd /home/ubuntu/api
          nohup java -jar -Dspring.profiles.active=prod flobank-api.jar > api.log 2>&1 &
          
  # 3. AP 서버 배포 작업
  deploy-ap:
    needs: build # build 작업이 성공해야 실행
    runs-on: ubuntu-latest
    steps:
    - name: 1. AP 서버 아티팩트 다운로드
      uses: actions/download-artifact@v4
      with:
        name: ap-jar # build에서 업로드한 이름

    - name: 2. AP 서버에 배포 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AP_SERVER_HOST }}     # GitHub Secret에서 가져오기
        username: ${{ secrets.AP_SERVER_USER }} # GitHub Secret에서 가져오기
        key: ${{ secrets.AP_SERVER_KEY }}      # GitHub Secret에서 가져오기
        script: |
          # 1. 기존에 실행 중인 AP 서버 종료 (오류가 나도 계속 진행)
          pkill -f 'flobank-ap.jar' || true
          
          # 2. 새 .jar 파일을 서버의 /home/ubuntu/ap/ 폴더로 이동 (경로는 예시)
          #    (이 폴더는 서버에 미리 만들어 두어야 합니다!)
          mkdir -p /home/ubuntu/ap
          mv ./*.jar /home/ubuntu/ap/flobank-ap.jar
          
          # 3. 'prod' 프로필로 새 애플리케이션 실행
          cd /home/ubuntu/ap
          nohup java -jar -Dspring.profiles.active=prod flobank-ap.jar > ap.log 2>&1 &