<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과 - FloBank</title>

    <link rel="stylesheet" th:href="@{/css/index.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous"/>

    <style>
        /* 로딩 및 결과 없음 스타일 */
        .no-result, .loading { text-align: center; padding: 50px; color: #777; background: #f8f9fa; border-radius: 10px; margin-top: 20px; }
        /* 탭 커서 포인터 */
        .search-tabs li { cursor: pointer; }
    </style>
</head>
<body>

<div th:replace="~{_template/_header :: header}"></div>

<main class="search-result-container">
    <h2 class="search-title">통합검색 결과</h2>

    <p class="search-summary">
        "<span class="highlight-keyword" th:text="${keyword}">검색어</span>"에 대한 검색 결과가 총
        <strong id="total-count"></strong>건 검색되었습니다.
    </p>

    <form class="search-bar" action="/flobank/search" method="get">
        <input type="text" name="keyword" id="pageSearchInput" th:value="${keyword}" placeholder="검색어를 입력하세요">
        <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
    </form>

    <ul class="search-tabs">
        <li class="active" data-tab="all">통합검색</li>
        <li data-tab="product">상품</li>
        <li data-tab="faq">FAQ</li>
        <li data-tab="docs">약관</li>
        <li data-tab="notice">공지사항</li>
        <li data-tab="event">이벤트</li>
    </ul>

    <div id="search-result-content">
        <div class="loading">검색 결과를 불러오는 중입니다...</div>
    </div>

</main>

<div th:replace="~{_template/_footer :: footer}"></div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        // Thymeleaf에서 넘겨준 검색어 변수 받기
        const currentKeyword = [[${keyword}]];
        const contextPath = "/flobank"; // Context Path 설정

        // DOM 요소 선택
        const resultContainer = document.getElementById('search-result-content');
        const totalCountEl = document.getElementById('total-count');
        const tabs = document.querySelectorAll('.search-tabs li');

        // 검색어가 있으면 즉시 API 호출
        if (currentKeyword) {
            fetchIntegratedSearch(currentKeyword);
        } else {
            resultContainer.innerHTML = '<div class="no-result">검색어를 입력해주세요.</div>';
        }

        // 탭 클릭 이벤트 핸들러
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 활성화 스타일 변경
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const type = tab.getAttribute('data-tab');

                if (type === 'all') {
                    fetchIntegratedSearch(currentKeyword);
                } else {
                    fetchTabSearch(currentKeyword, type, 0);
                }
            });
        });

        // -------------------------------------------------------
        //  1. 통합 검색 API 호출 (토큰 추가됨)
        // -------------------------------------------------------
        async function fetchIntegratedSearch(keyword) {
            try {
                // 로딩 표시
                resultContainer.innerHTML = '<div class="loading">결과를 불러오는 중...</div>';

                const url = `${contextPath}/api/search/integrated?keyword=${encodeURIComponent(keyword)}`;

                // [핵심 수정] 토큰 헤더 추가 로직
                const token = localStorage.getItem('accessToken');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                // headers 포함하여 요청 전송
                const response = await fetch(url, { headers: headers });

                if (!response.ok) throw new Error('API call failed');

                const data = await response.json();
                renderIntegratedResults(data);

            } catch (error) {
                console.error(error);
                resultContainer.innerHTML = '<div class="no-result">검색 중 오류가 발생했습니다.</div>';
            }
        }

        // -------------------------------------------------------
        // 2. 탭별 상세 검색 API 호출 (토큰 추가됨)
        // -------------------------------------------------------
        async function fetchTabSearch(keyword, type, page) {
            try {
                resultContainer.innerHTML = '<div class="loading">상세 결과를 불러오는 중...</div>';

                const url = `${contextPath}/api/search/tab?keyword=${encodeURIComponent(keyword)}&type=${type}&page=${page}`;

                // [핵심 수정] 토큰 헤더 추가 로직
                const token = localStorage.getItem('accessToken');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(url, { headers: headers });

                if (!response.ok) throw new Error('API call failed');

                const data = await response.json();
                renderTabResults(data, type);

            } catch (error) {
                console.error(error);
                resultContainer.innerHTML = '<div class="no-result">데이터를 불러올 수 없습니다.</div>';
            }
        }

        // -------------------------------------------------------
        //  3. 통합 검색 결과 렌더링 (HTML 생성)
        // -------------------------------------------------------
        function renderIntegratedResults(data) {
            // 총 개수 업데이트
            totalCountEl.textContent = data.totalCount || 0;
            resultContainer.innerHTML = ''; // 초기화

            if (!data.sections || data.totalCount === 0) {
                resultContainer.innerHTML = '<div class="no-result">검색 결과가 없습니다.</div>';
                return;
            }

            // 보여줄 섹션 순서 정의
            const sectionOrder = ['menu', 'product', 'faq', 'docs', 'notice', 'event'];

            sectionOrder.forEach(key => {
                const sectionData = data.sections[key];

                // 데이터가 있는 섹션만 그리기
                if (sectionData && sectionData.results && sectionData.results.length > 0) {
                    const sectionHtml = document.createElement('section');
                    sectionHtml.className = 'search-section';
                    sectionHtml.setAttribute('data-tab', key);

                    // 섹션 헤더 (더보기 버튼 포함)
                    sectionHtml.innerHTML = `
                        <h3>${sectionData.title} (${sectionData.totalCount})
                            <span class="more" onclick="triggerTabClick('${key}')">더보기</span>
                        </h3>
                        <ul>
                            ${sectionData.results.map(item => createListItem(item)).join('')}
                        </ul>
                    `;
                    resultContainer.appendChild(sectionHtml);
                }
            });
        }

        // -------------------------------------------------------
        // 4. 탭 상세 결과 렌더링
        // -------------------------------------------------------
        function renderTabResults(data, type) {
            // 탭 검색은 sections 안에 해당 타입 하나만 옴
            const sectionData = data.sections ? data.sections[type] : null;

            resultContainer.innerHTML = ''; // 초기화

            if (!sectionData || !sectionData.results || sectionData.results.length === 0) {
                resultContainer.innerHTML = '<div class="no-result">해당 카테고리에 결과가 없습니다.</div>';
                totalCountEl.textContent = 0;
                return;
            }

            // 총 개수 업데이트
            totalCountEl.textContent = sectionData.totalCount;

            const sectionHtml = document.createElement('section');
            sectionHtml.className = 'search-section';
            sectionHtml.innerHTML = `
                <h3>${sectionData.title} 전체 목록</h3>
                <ul>
                    ${sectionData.results.map(item => createListItem(item)).join('')}
                </ul>
                `;
            resultContainer.appendChild(sectionHtml);
        }

        // -------------------------------------------------------
        // 공통: 리스트 아이템 HTML 생성기
        // -------------------------------------------------------
        function createListItem(item) {
            // 링크가 있으면 링크 태그, 없으면 #
            // (SearchService에서 이미 URL을 정제해서 보내주므로 contextPath만 붙임)
            const link = item.url ? `${contextPath}${item.url}` : '#';

            // 날짜 등이 있으면 표시
            const extraInfo = item.extra ? `<span>${item.extra}</span>` : '';

            return `
                <li>
                    <a href="${link}">${item.title}</a>
                    ${item.summary ? `<p style="font-size:14px; color:#666; margin-top:5px;">${item.summary}</p>` : ''}
                    ${extraInfo}
                </li>
            `;
        }
    });

    // [전역 함수] 더보기 클릭 시 해당 탭을 강제로 클릭하게 만듦
    function triggerTabClick(type) {
        const tab = document.querySelector(`.search-tabs li[data-tab="${type}"]`);
        if (tab) tab.click();
    }
</script>

</body>
</html>