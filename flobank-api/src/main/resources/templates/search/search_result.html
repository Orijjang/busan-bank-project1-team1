<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과 - FloBank</title>

    <link rel="stylesheet" th:href="@{/css/index.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous"/>

    <style>
        /* 로딩 및 결과 없음 스타일 */
        .no-result, .loading { text-align: center; padding: 50px; color: #777; background: #f8f9fa; border-radius: 10px; margin-top: 20px; }
        /* 탭 커서 포인터 */
        .search-tabs li { cursor: pointer; }
    </style>
</head>
<body>

<div th:replace="~{_template/_header :: header}"></div>

<main class="search-result-container">
    <h2 class="search-title">통합검색 결과</h2>

    <p class="search-summary">
        "<span class="highlight-keyword" th:text="${keyword}">검색어</span>"에 대한 검색 결과가 총
        <strong id="total-count"></strong>건 검색되었습니다.
    </p>

    <form class="search-bar" action="/flobank/search" method="get">
        <input
                type="text"
                name="keyword"
                id="pageSearchInput"
                th:value="${keyword}"
                placeholder="검색어를 입력하세요"
                autocomplete="off"
        >
        <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>

        <ul id="pageAutocompleteList" class="autocomplete-dropdown"></ul>
    </form>

    <ul class="search-tabs">
        <li class="active" data-tab="all">통합검색</li>
        <li data-tab="product">상품</li>
        <li data-tab="faq">FAQ</li>
        <li data-tab="docs">약관</li>
        <li data-tab="notice">공지사항</li>
        <li data-tab="event">이벤트</li>
    </ul>

    <div id="search-result-content">
        <div class="loading">검색 결과를 불러오는 중입니다...</div>
    </div>

</main>

<div th:replace="~{_template/_footer :: footer}"></div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        // -------------------------------------------------------
        // [기본 설정] 변수 및 상수
        // -------------------------------------------------------
        const currentKeyword = [[${keyword}]]; // Thymeleaf 변수
        const contextPath = "/flobank";

        // DOM 요소 선택
        const resultContainer = document.getElementById('search-result-content');
        const totalCountEl = document.getElementById('total-count');
        const tabs = document.querySelectorAll('.search-tabs li');

        // [추가] 자동완성 관련 DOM
        const searchForm = document.querySelector('.search-bar');
        const searchInput = document.getElementById('pageSearchInput');
        const autocompleteList = document.getElementById('pageAutocompleteList');

        // -------------------------------------------------------
        // [유틸] 디바운스 함수 (index.js와 동일)
        // -------------------------------------------------------
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // -------------------------------------------------------
        // [유틸] 쿠키 가져오기 (index.js와 동일)
        // -------------------------------------------------------
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // -------------------------------------------------------
        // [로직] 초기 검색 결과 로드 (기존 코드 유지)
        // -------------------------------------------------------
        if (currentKeyword) {
            fetchIntegratedSearch(currentKeyword);
        } else {
            resultContainer.innerHTML = '<div class="no-result">검색어를 입력해주세요.</div>';
        }

        // -------------------------------------------------------
        // [이벤트] 1. 검색어 입력 시 자동완성 (디바운스 적용)
        // -------------------------------------------------------
        const onInputHandler = debounce((e) => {
            const keyword = e.target.value.trim();
            fetchAutocomplete(keyword);
        }, 300); // 0.3초 딜레이

        searchInput.addEventListener('input', onInputHandler);

        // 포커스 시에도 값이 있으면 자동완성 표시
        searchInput.addEventListener('focus', () => {
            if(searchInput.value.trim().length > 0) {
                fetchAutocomplete(searchInput.value.trim());
            }
        });

        // -------------------------------------------------------
        // [이벤트] 2. 외부 클릭 시 자동완성 닫기
        // -------------------------------------------------------
        document.addEventListener('click', (e) => {
            if (!searchForm.contains(e.target)) {
                if (autocompleteList) autocompleteList.style.display = 'none';
            }
        });

        // -------------------------------------------------------
        // [API] 자동완성 데이터 호출 (index.js 로직 이식)
        // -------------------------------------------------------
        async function fetchAutocomplete(keyword) {
            // 검색어 없으면 숨김
            if (!keyword || keyword.trim().length < 1) {
                autocompleteList.style.display = 'none';
                return;
            }

            try {
                const url = `${contextPath}/api/search/autocomplete?keyword=${encodeURIComponent(keyword)}`;

                // 토큰 로직 (index.js와 동일하게 cookie까지 체크)
                let token = localStorage.getItem('accessToken');
                if (!token) token = getCookie('accessToken');

                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(url, { headers: headers });

                if (response.ok) {
                    const suggestions = await response.json();
                    renderAutocomplete(suggestions, keyword);
                }
            } catch (error) {
                console.error("자동완성 로드 실패:", error);
            }
        }

        // -------------------------------------------------------
        // [렌더링] 자동완성 목록 그리기 (index.js 로직 이식)
        // -------------------------------------------------------
        function renderAutocomplete(suggestions, keyword) {
            autocompleteList.innerHTML = ''; // 초기화

            if (!suggestions || suggestions.length === 0) {
                autocompleteList.style.display = 'none';
                return;
            }

            // 목록 보이기
            autocompleteList.style.display = 'block';

            suggestions.forEach(text => {
                const li = document.createElement('li');

                // 하이라이팅: 검색어와 일치하는 부분 강조
                // index.js의 스타일과 CSS 파일 클래스를 매칭시킴
                const regex = new RegExp(`(${keyword})`, 'gi');
                const highlightedText = text.replace(regex, '<span class="highlight-text">$1</span>');

                li.innerHTML = highlightedText;

                // 클릭 시 검색 실행
                li.addEventListener('click', () => {
                    searchInput.value = text;
                    autocompleteList.style.display = 'none';
                    searchForm.submit(); // 폼 제출로 페이지 이동
                });

                autocompleteList.appendChild(li);
            });
        }

        // =======================================================
        //  기존 검색 결과(통합검색, 탭검색) 관련 함수들은 아래 유지
        // =======================================================

        // 탭 클릭 이벤트
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const type = tab.getAttribute('data-tab');
                if (type === 'all') fetchIntegratedSearch(currentKeyword);
                else fetchTabSearch(currentKeyword, type, 0);
            });
        });

        // 통합 검색 API (기존 코드 유지)
        async function fetchIntegratedSearch(keyword) {
            try {
                resultContainer.innerHTML = '<div class="loading">결과를 불러오는 중...</div>';
                const url = `${contextPath}/api/search/integrated?keyword=${encodeURIComponent(keyword)}`;

                let token = localStorage.getItem('accessToken');
                if (!token) token = getCookie('accessToken'); // 여기도 동일하게 쿠키 체크 추가해주면 좋음

                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(url, { headers: headers });
                if (!response.ok) throw new Error('API call failed');

                const data = await response.json();
                renderIntegratedResults(data);
            } catch (error) {
                console.error(error);
                resultContainer.innerHTML = '<div class="no-result">검색 중 오류가 발생했습니다.</div>';
            }
        }

        // 탭별 검색 API (기존 코드 유지)
        async function fetchTabSearch(keyword, type, page) {
            try {
                resultContainer.innerHTML = '<div class="loading">상세 결과를 불러오는 중...</div>';
                const url = `${contextPath}/api/search/tab?keyword=${encodeURIComponent(keyword)}&type=${type}&page=${page}`;

                let token = localStorage.getItem('accessToken');
                if (!token) token = getCookie('accessToken');

                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(url, { headers: headers });
                if (!response.ok) throw new Error('API call failed');

                const data = await response.json();
                renderTabResults(data, type);
            } catch (error) {
                console.error(error);
                resultContainer.innerHTML = '<div class="no-result">데이터를 불러올 수 없습니다.</div>';
            }
        }

        // (기존) 통합 검색 결과 렌더링 함수
        function renderIntegratedResults(data) {
            totalCountEl.textContent = data.totalCount || 0;
            resultContainer.innerHTML = '';

            if (!data.sections || data.totalCount === 0) {
                resultContainer.innerHTML = '<div class="no-result">검색 결과가 없습니다.</div>';
                return;
            }

            const sectionOrder = ['menu', 'product', 'faq', 'docs', 'notice', 'event'];
            sectionOrder.forEach(key => {
                const sectionData = data.sections[key];
                if (sectionData && sectionData.results && sectionData.results.length > 0) {
                    const sectionHtml = document.createElement('section');
                    sectionHtml.className = 'search-section';
                    sectionHtml.setAttribute('data-tab', key);
                    sectionHtml.innerHTML = `
                    <h3>${sectionData.title} (${sectionData.totalCount})
                        <span class="more" onclick="triggerTabClick('${key}')">더보기</span>
                    </h3>
                    <ul>
                        ${sectionData.results.map(item => createListItem(item)).join('')}
                    </ul>
                `;
                    resultContainer.appendChild(sectionHtml);
                }
            });
        }

        // (기존) 탭 상세 결과 렌더링 함수
        function renderTabResults(data, type) {
            const sectionData = data.sections ? data.sections[type] : null;
            resultContainer.innerHTML = '';

            if (!sectionData || !sectionData.results || sectionData.results.length === 0) {
                resultContainer.innerHTML = '<div class="no-result">해당 카테고리에 결과가 없습니다.</div>';
                totalCountEl.textContent = 0;
                return;
            }

            totalCountEl.textContent = sectionData.totalCount;
            const sectionHtml = document.createElement('section');
            sectionHtml.className = 'search-section';
            sectionHtml.innerHTML = `
            <h3>${sectionData.title} 전체 목록</h3>
            <ul>
                ${sectionData.results.map(item => createListItem(item)).join('')}
            </ul>
        `;
            resultContainer.appendChild(sectionHtml);
        }

        // (기존) 리스트 아이템 생성 함수
        function createListItem(item) {
            let linkUrl = '#';
            let targetAttr = '';
            if (item.thistFile) {
                linkUrl = `${contextPath}${item.thistFile}`;
                targetAttr = 'target="_blank"';
            } else if (item.url) {
                linkUrl = `${contextPath}${item.url}`;
            }
            const extraInfo = item.extra ? `<span>${item.extra}</span>` : '';
            return `
            <li>
                <a href="${linkUrl}" ${targetAttr}>${item.title}</a>
                ${item.summary ? `<p style="font-size:14px; color:#666; margin-top:5px;">${item.summary}</p>` : ''}
                ${extraInfo}
            </li>
        `;
        }
    });

    // [전역 함수] 더보기 클릭 용 (기존 유지)
    function triggerTabClick(type) {
        const tab = document.querySelector(`.search-tabs li[data-tab="${type}"]`);
        if (tab) tab.click();
    }
</script>

</body>
</html>